{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Cargar / Editar Calificaciones" %} - {{ materia.nombre }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{% trans "Cargar / Editar Calificaciones" %} - {{ materia.nombre }}</h2>
                <a href="{% url 'calificaciones_curso' comision.codigo %}" class="btn btn-secondary">{% trans "Volver" %}</a>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">{% trans "Información de la Calificación" %} - {% trans "Comisión" %}: {{ comision.codigo }}</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'crear_calificacion' codigo=comision.codigo %}">
                        {% csrf_token %}
                        
                        <input type="hidden" name="materia_id" value="{{ materia.id }}">
                        <input type="hidden" name="comision_id" value="{{ comision.id }}">
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="id_tipo" class="form-label">{% trans "Tipo de Calificación" %} *</label>
                                <select class="form-select" id="id_tipo" name="tipo" required>
                                    <option value="">{% trans "Seleccionar tipo" %}</option>
                                    {% for tipo_value, tipo_label in tipos_calificacion %}
                                    <option value="{{ tipo_value }}" {% if tipo_value == pre_selected_tipo %}selected{% endif %}>{{ tipo_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="id_numero" class="form-label">{% trans "Número de Instancia" %} *</label>
                                <input type="number" class="form-control" id="id_numero" name="numero" value="1" min="1" required>
                                <div class="form-text">{% trans "Ej: 1 para 1er Parcial, 2 para 2do Parcial." %}</div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_fecha" class="form-label">{% trans "Fecha de Calificación" %} *</label>
                                <input type="date" class="form-control" id="id_fecha" name="fecha" required 
                                       value="{{ hoy|date:'Y-m-d' }}">
                            </div>
                        </div>

                        <hr>
                        
                        <h5 class="mb-3">{% trans "Calificaciones de Estudiantes" %}</h5>
                        <p class="text-muted">{% trans "Ingrese las notas entre 0.00 y 10.00. Si ya existe una calificación para el tipo e instancia seleccionados, su valor será precargado." %}</p>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="tabla-estudiantes">
                                <thead class="table-dark">
                                    <tr>
                                        <th>{% trans "Estudiante" %}</th>
                                        <th>{% trans "DNI" %}</th>
                                        <th>{% trans "Legajo" %}</th>
                                        <th>{% trans "Nota" %} (0-10)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inscripcion in inscripciones %}
                                    <tr data-alumno-id="{{ inscripcion.alumno.id }}">
                                        <td>{{ inscripcion.alumno.nombre }} {{ inscripcion.alumno.apellido }}</td>
                                        <td>{{ inscripcion.alumno.dni }}</td>
                                        <td>{{ inscripcion.alumno.legajo|default:"-" }}</td>
                                        <td>
                                            <input type="number" class="form-control nota-input" 
                                                   name="nota_{{ inscripcion.alumno.id }}" 
                                                   min="0" max="10" step="0.01" 
                                                   placeholder="0.00 - 10.00"
                                                   data-alumno-id="{{ inscripcion.alumno.id }}">
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">{% trans "No hay estudiantes inscritos en esta comisión" %}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> {% trans "Las notas se guardarán o actualizarán como calificaciones del tipo seleccionado para cada estudiante." %}
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-outline-secondary me-md-2" id="btn-limpiar">
                                <i class="bi bi-eraser"></i> {% trans "Limpiar Todas" %}
                            </button>
                            <button type="submit" class="btn btn-success" id="btn-guardar">
                                <i class="bi bi-save"></i> {% trans "Guardar Calificaciones" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.nota-input {
    width: 120px;
}
.estado {
    min-width: 100px;
    display: inline-block;
    text-align: center;
}
.highlight-row {
    background-color: #fff3cd; /* Color amarillo claro */
    transition: background-color 0.5s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const notasPorAlumno = JSON.parse('{{ notas_por_alumno_json|escapejs }}');
        const selectTipo = document.getElementById('id_tipo');
        const inputNumero = document.getElementById('id_numero');
        const notaInputs = document.querySelectorAll('.nota-input');
        const btnLimpiar = document.getElementById('btn-limpiar');
        const preSelectedTipo = "{{ pre_selected_tipo|escapejs }}";
        const preSelectedAlumnoId = "{{ pre_selected_alumno_id|escapejs }}";

        // Pre-seleccionar tipo si viene en la URL
        if (preSelectedTipo) {
            selectTipo.value = preSelectedTipo;
        }

        function cargarNotas() {
            const tipoSeleccionado = selectTipo.value;
            const numeroSeleccionado = parseInt(inputNumero.value) || 1;

            notaInputs.forEach(input => {
                const alumnoId = input.dataset.alumnoId;
                if (tipoSeleccionado && 
                    notasPorAlumno[alumnoId] && 
                    notasPorAlumno[alumnoId][tipoSeleccionado] &&
                    notasPorAlumno[alumnoId][tipoSeleccionado][numeroSeleccionado] !== undefined) {
                    
                    input.value = notasPorAlumno[alumnoId][tipoSeleccionado][numeroSeleccionado];
                } else {
                    input.value = '';
                }
            });
        }

        selectTipo.addEventListener('change', cargarNotas);
        inputNumero.addEventListener('input', cargarNotas); // Actualizar al cambiar número

        btnLimpiar.addEventListener('click', function() {
            notaInputs.forEach(input => {
                input.value = '';
            });
        });

        cargarNotas(); 

        // Resaltar alumno si viene en la URL
        if (preSelectedAlumnoId) {
            const alumnoRow = document.querySelector(`tr[data-alumno-id="${preSelectedAlumnoId}"]`);
            if (alumnoRow) {
                alumnoRow.classList.add('highlight-row');
                alumnoRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Quitar el resaltado después de un tiempo
                setTimeout(() => {
                    alumnoRow.classList.remove('highlight-row');
                }, 3000); 
            }
        }
    });
</script>
{% endblock %}