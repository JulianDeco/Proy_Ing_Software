{% extends 'base.html' %}
{% load static %}

{% block title %}Histórico de Mesas - {{ alumno.nombre }} {{ alumno.apellido }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-clock-history"></i> Histórico de Mesas de Examen</h1>
            <p class="text-muted mb-0">
                <strong>{{ alumno.apellido }}, {{ alumno.nombre }}</strong> - Legajo: {{ alumno.legajo }} - DNI: {{ alumno.dni }}
            </p>
        </div>
        <a href="javascript:history.back()" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <!-- Resumen Estadístico -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card h-100 border-start border-primary border-4">
                <div class="card-body text-center">
                    <i class="bi bi-clipboard-check text-primary fs-1 mb-2"></i>
                    <h3 class="mb-0">{{ total_mesas }}</h3>
                    <p class="text-muted mb-0">Total Mesas</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card h-100 border-start border-success border-4">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
                    <h3 class="mb-0">{{ total_aprobadas }}</h3>
                    <p class="text-muted mb-0">Aprobadas</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card h-100 border-start border-danger border-4">
                <div class="card-body text-center">
                    <i class="bi bi-x-circle-fill text-danger fs-1 mb-2"></i>
                    <h3 class="mb-0">{{ total_desaprobadas }}</h3>
                    <p class="text-muted mb-0">Desaprobadas</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card h-100 border-start border-info border-4">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up text-info fs-1 mb-2"></i>
                    <h3 class="mb-0">{{ promedio_examenes }}</h3>
                    <p class="text-muted mb-0">Promedio Exámenes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs para filtrar por estado -->
    <ul class="nav nav-tabs mb-3" id="mesasTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="todas-tab" data-bs-toggle="tab" data-bs-target="#todas"
                    type="button" role="tab">
                Todas ({{ total_mesas }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="aprobadas-tab" data-bs-toggle="tab" data-bs-target="#aprobadas"
                    type="button" role="tab">
                <span class="text-success"><i class="bi bi-check-circle"></i> Aprobadas ({{ total_aprobadas }})</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="desaprobadas-tab" data-bs-toggle="tab" data-bs-target="#desaprobadas"
                    type="button" role="tab">
                <span class="text-danger"><i class="bi bi-x-circle"></i> Desaprobadas ({{ total_desaprobadas }})</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ausentes-tab" data-bs-toggle="tab" data-bs-target="#ausentes"
                    type="button" role="tab">
                <span class="text-warning"><i class="bi bi-dash-circle"></i> Ausentes ({{ total_ausentes }})</span>
            </button>
        </li>
    </ul>

    <!-- Contenido de Tabs -->
    <div class="tab-content" id="mesasTabsContent">
        <!-- Todas las Mesas -->
        <div class="tab-pane fade show active" id="todas" role="tabpanel">
            <div class="card">
                <div class="card-body p-0">
                    {% if inscripciones %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Materia</th>
                                    <th>Fecha Examen</th>
                                    <th>Año Académico</th>
                                    <th>Condición</th>
                                    <th>Nota</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscripcion in inscripciones %}
                                <tr>
                                    <td><strong>{{ inscripcion.mesa_examen.materia.nombre }}</strong></td>
                                    <td>{{ inscripcion.mesa_examen.fecha_examen|date:"d/m/Y H:i" }}</td>
                                    <td>{{ inscripcion.mesa_examen.anio_academico.nombre }}</td>
                                    <td>
                                        {% if inscripcion.condicion == 'REGULAR' %}
                                            <span class="badge bg-success">{{ inscripcion.get_condicion_display }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">{{ inscripcion.get_condicion_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if inscripcion.nota_examen %}
                                            <strong class="fs-5">{{ inscripcion.nota_examen }}</strong>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if inscripcion.estado_inscripcion == 'APROBADO' %}
                                            <span class="badge bg-success">{{ inscripcion.get_estado_inscripcion_display }}</span>
                                        {% elif inscripcion.estado_inscripcion == 'DESAPROBADO' %}
                                            <span class="badge bg-danger">{{ inscripcion.get_estado_inscripcion_display }}</span>
                                        {% elif inscripcion.estado_inscripcion == 'AUSENTE' %}
                                            <span class="badge bg-warning text-dark">{{ inscripcion.get_estado_inscripcion_display }}</span>
                                        {% else %}
                                            <span class="badge bg-primary">{{ inscripcion.get_estado_inscripcion_display }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-1"></i>
                        <p class="mt-3">No hay mesas registradas</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mesas Aprobadas -->
        <div class="tab-pane fade" id="aprobadas" role="tabpanel">
            <div class="card">
                <div class="card-body p-0">
                    {% if mesas_aprobadas %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Materia</th>
                                    <th>Fecha Examen</th>
                                    <th>Año Académico</th>
                                    <th>Condición</th>
                                    <th>Nota</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscripcion in mesas_aprobadas %}
                                <tr class="table-success">
                                    <td><strong>{{ inscripcion.mesa_examen.materia.nombre }}</strong></td>
                                    <td>{{ inscripcion.mesa_examen.fecha_examen|date:"d/m/Y H:i" }}</td>
                                    <td>{{ inscripcion.mesa_examen.anio_academico.nombre }}</td>
                                    <td>
                                        {% if inscripcion.condicion == 'REGULAR' %}
                                            <span class="badge bg-success">{{ inscripcion.get_condicion_display }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">{{ inscripcion.get_condicion_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td><strong class="text-success fs-5">{{ inscripcion.nota_examen }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-1"></i>
                        <p class="mt-3">No hay mesas aprobadas</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mesas Desaprobadas -->
        <div class="tab-pane fade" id="desaprobadas" role="tabpanel">
            <div class="card">
                <div class="card-body p-0">
                    {% if mesas_desaprobadas %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Materia</th>
                                    <th>Fecha Examen</th>
                                    <th>Año Académico</th>
                                    <th>Condición</th>
                                    <th>Nota</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscripcion in mesas_desaprobadas %}
                                <tr class="table-danger">
                                    <td><strong>{{ inscripcion.mesa_examen.materia.nombre }}</strong></td>
                                    <td>{{ inscripcion.mesa_examen.fecha_examen|date:"d/m/Y H:i" }}</td>
                                    <td>{{ inscripcion.mesa_examen.anio_academico.nombre }}</td>
                                    <td>
                                        {% if inscripcion.condicion == 'REGULAR' %}
                                            <span class="badge bg-success">{{ inscripcion.get_condicion_display }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">{{ inscripcion.get_condicion_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td><strong class="text-danger fs-5">{{ inscripcion.nota_examen }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-1"></i>
                        <p class="mt-3">No hay mesas desaprobadas</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mesas Ausentes -->
        <div class="tab-pane fade" id="ausentes" role="tabpanel">
            <div class="card">
                <div class="card-body p-0">
                    {% if mesas_ausentes %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Materia</th>
                                    <th>Fecha Examen</th>
                                    <th>Año Académico</th>
                                    <th>Condición</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscripcion in mesas_ausentes %}
                                <tr class="table-warning">
                                    <td><strong>{{ inscripcion.mesa_examen.materia.nombre }}</strong></td>
                                    <td>{{ inscripcion.mesa_examen.fecha_examen|date:"d/m/Y H:i" }}</td>
                                    <td>{{ inscripcion.mesa_examen.anio_academico.nombre }}</td>
                                    <td>
                                        {% if inscripcion.condicion == 'REGULAR' %}
                                            <span class="badge bg-success">{{ inscripcion.get_condicion_display }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">{{ inscripcion.get_condicion_display }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-1"></i>
                        <p class="mt-3">No hay ausencias registradas</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    font-weight: 600;
    background-color: #f8f9fa;
}

.nav-tabs .nav-link {
    color: #495057;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}
</style>
{% endblock %}
